#!/usr/bin/ruby

require 'pathname'
require 'yaml'
require 'net/http'
require 'uri'
require 'ap'
require 'csv'
require 'bigdecimal'

require 'yahoo_stock' # gem 'nas-yahoo_stock'

config = YAML.load_file(Pathname.new("~/.stock-portfolio.yml").expand_path)

symbols = config['stocks'].keys
format = "nsl1"

prices = symbols.map(&:to_sym).map { |x| [x,nil] }.to_h
YahooStock::Quote.new(stock_symbols: symbols, read_parameters: [:symbol, :name, :bid, :bid_real_time]).results(:to_hash).output.each do |stock|
	bid =
		if stock[:bid_real_time] != 'N/A'
			stock[:bid_real_time]
		elsif stock[:bid] != 'N/A'
			stock[:bid]
		else
			raise 'Cannot get bid'
		end

	prices[stock[:symbol].to_sym] = {
		name: stock[:name],
		latest_value: BigDecimal.new(bid),
		amount: config['stocks'][stock[:symbol]]
	}
end

raise "Something is missing..." unless prices.values.all?

total_stocks = prices.map { |_, hash| hash[:latest_value] * hash[:amount] }.inject(&:+)
usd = BigDecimal.new(config['USD'], 3) # precision 3

total_usd = usd + total_stocks

# TODO: tfuj
require_relative 'btckit/bank.rb'
require_relative 'btckit/config.rb'

btckit_config = BtcKit::Config.new
bank = BtcKit::Bank.new(btckit_config.bank_filename)

initial_czk = config['CZK']
total_czk = bank.exchange(total_usd, 'USD', 'CZK').cents + initial_czk

if ARGV.include?('--raw')
	puts total_czk
else
	puts '$%.2f + %d Kč (%d Kč)' % [total_usd, initial_czk, total_czk]
end
